<div class="container mt-2 mb-5">
    <div class="row">
        <div class="col text-center">
            <h1 class="org display-2 fw-bold p-3">{{ org }}</h1>
        </div>
     </div>

    <div class="row mt-2">
        <div class="col-4" id="container-variables">
            <h3><span class="visible-results">{{ results.count('all') | format_number }}</span> Variables &amp; Secrets</h3>
            <div class="input-group mb-1">
                <input type="text" class="form-control search" placeholder="search">
            </div>
            <div class="row filters">
                <div class="col">
                    <!-- Variables -->
                    {{ badge_filter(
                        'filter-variables',
                        'text-bg-primary',
                        'variables (' ~ (results.count('variables') | format_number) ~ ')',
                        '<i class="fa-solid fa-square-root-variable"></i>',
                        True)
                    }}

                    <!-- Secrets -->
                    {{ badge_filter(
                        'filter-secrets',
                        'text-bg-primary',
                        'secrets (' ~ (results.count('secrets') | format_number) ~ ')',
                        '<i class="fa-solid fa-key"></i>',
                        True)
                    }}
                </div>
            </div>
            <div class="row mt-3">
                <div class="col">
                    <div class="sidebar">
                        <ul class="list-group list-group-flush">
                            {% for name, item in results.all.items() %}
                            <li class="list-group-item d-flex align-items-center overflow-auto ps-0 vars-and-secrets" data-type="{{ item.type }}">
                                <div class="ms-2 me-auto">
                                    {% if item.type == 'variable' %}
                                    <span title="Variable"><i class="fa-solid fa-square-root-variable"></i></span>
                                    {% else %}
                                    <span title="Secret"><i class="fa-solid fa-key text-danger"></i></span>
                                    {% endif %}
                                    <a href="#" class="name">{{ name }}</a>
                                </div>
                                <span class="badge text-bg-secondary">{{ item.count }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col" id="container-workflows">
            <h3><span class="visible-results">{{ results.count('workflows') | format_number }}</span> Workflows</h3>
            <div class="input-group mb-1">
                <input type="text" class="form-control search" placeholder="search">
            </div>
            <div class="row">
                <div class="col text-end">
                    <a href="#" class="badge text-bg-info selected-filter d-none text-decoration-none"><span class="filter-value"></span> <i class="fa-solid fa-xmark"></i></a>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <ul class="list-group list-group-flush">
                        {% for result in results.workflows %}
                        <li class="list-group-item ps-0 workflow">
                            <div class="row">
                                <div class="col">
                                    <a href="{{ result.workflow.url(True) }}" class="name">{{ result.workflow }}</a>
                                </div>
                            </div>
                            <div class="row mt-1">
                                <div class="col variables-and-secrets">
                                    {% for secret in result.secrets %}
                                    <span title="Secret" class="badge text-bg-danger p-1 name" data-type="secret" data-name="{{ secret }}"><i class="fa-solid fa-key me-1"></i>{{ secret }}</span>
                                    {% endfor %}
                                    {% for variable in result.variables %}
                                    <span title="Variable" class="badge text-bg-primary p-1 name" data-type="variable" data-name="{{ variable }}"><i class="fa-solid fa-square-root-variable me-1"></i>{{ variable }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const VariableManager = {
        init: function() {
            $('.filter').click(function() {
                VariableManager.filter($(this));
            });

            $('.search').keyup(function() {
                VariableManager.filter($(this));
            });

            $('#container-variables .vars-and-secrets .name').click(function() {
                VariableManager.filter_by_var_or_secret($(this));
                return false;
            });

            $('#container-workflows .selected-filter').click(function() {
                $(this).addClass('d-none').find('.filter-value').text('');
                VariableManager.filter(null);
                return false;
            });
        },

        filter: function(element) {
            this.__variable_secret_filters();
            this.__workflow_filters();
            this.__update_result_counts();
        },

        filter_by_var_or_secret: function(element) {
            $('#container-workflows .workflow').addClass('d-none');

            let var_name = $(element).text().trim().toUpperCase();

            $('#container-workflows .selected-filter').removeClass('d-none').find('.filter-value').text(var_name);

            $('#container-workflows .workflow .variables-and-secrets .name').each(function() {
                let name = $(this).text().trim().toUpperCase();
                if (name === var_name) {
                    $(this).closest('.workflow').removeClass('d-none');
                }
            });

            this.__update_result_counts();
        },

        __variable_secret_filters: function() {
            let filters = {};
            $('#container-variables .filter').each(function() {
                filters[$(this).data('filter')] = $(this).is(':checked');
            });

            $('#container-variables .vars-and-secrets').each(function() {
                // Start from a visible state.
                $(this).removeClass('d-none');

                if ($(this).data('type') == 'variable' && !filters['filter-variables']) {
                    $(this).addClass('d-none');
                } else if ($(this).data('type') == 'secret' && !filters['filter-secrets']) {
                    $(this).addClass('d-none');
                }
            });

            let searchFor = $('#container-variables .search').val().toLowerCase();
            if (searchFor.length > 0) {
                $('#container-variables .vars-and-secrets').each(function() {
                    let name = $(this).find('.name').text().trim().toLowerCase();
                    if (!name.includes(searchFor)) {
                        $(this).addClass('d-none');
                    }
                });
            }
        },

        __workflow_filters: function() {
            $('#container-workflows .workflow').removeClass('d-none');

            let searchFor = $('#container-workflows .search').val().toLowerCase();
            if (searchFor.length > 0) {
                $('#container-workflows .workflow').each(function() {
                    let name = $(this).find('.name').text().trim().toLowerCase();
                    if (!name.includes(searchFor)) {
                        $(this).addClass('d-none');
                    }
                });
            }
        },

        __update_result_counts: function() {
            $('#container-variables .visible-results').text($('#container-variables .vars-and-secrets:visible').length.toLocaleString());
            $('#container-workflows .visible-results').text($('#container-workflows .workflow:visible').length.toLocaleString());
        }
    };

    $(document).ready(function() {
        VariableManager.init();
    });
</script>
