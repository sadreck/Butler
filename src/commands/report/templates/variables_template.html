<div class="container mt-2 mb-5">
    <div class="row">
        <div class="col text-center">
            <h1 class="org display-2 fw-bold p-3">{{ org }}</h1>
        </div>
     </div>

    <div class="row mt-2">
        <div class="col" id="filters">
            <h3><span class="visible-results">{{ results.count('all') | format_number }}</span> Variables &amp; Secrets</h3>
            <div class="input-group mb-1">
                <input type="text" class="form-control search" placeholder="search">
            </div>
            <div class="row">
                <div class="col-6">
                    <select class="form-control" id="variables" multiple>
                        {% for name, item in results.all.items() %}
                        {% if item.type == 'variable' %}
                        <option value="{{ name }}">{{ name }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div class="col-6">
                    <select class="form-control" id="secrets" multiple>
                        {% for name, item in results.all.items() %}
                        {% if item.type == 'secret' %}
                        <option value="{{ name }}">{{ name }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="row mt-1">
                <div class="col text-end">
                    <span class="badge text-bg-secret">secret</span>
                    <span class="badge text-bg-variable">variable</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3 mb-5" id="workflows">
        <div class="col striped-rows">
            {% for workflow in results.workflows %}
            <div class="row pb-1 pt-1 strip workflow" data-name="{{ workflow.workflow }}">
                <div class="col">
                    <div class="row">
                        <div class="col">
                            {% if workflow.workflow.repo.archive %}
                            <span class="badge text-bg-warning archived p-1"><i class="fa-solid fa-box-archive"></i></span>
                            {% endif %}

                            {% if workflow.workflow.repo.fork %}
                            <span class="badge text-bg-secondary forked p-1"><i class="fa-solid fa-code-fork"></i></span>
                            {% endif %}

                            <a href="{{ workflow.workflow.url(True) }}">{{ workflow.workflow }}</a>
                        </div>
                    </div>
                    <div class="row pb-1">
                        <div class="col ms-4">
                            {% if workflow.secrets | length > 0 %}
                            <div>
                                {% for secret in workflow.secrets %}
                                <span title="Secret" class="badge text-bg-secret variable-or-secret" data-type="secret" data-value="{{ secret }}">{{ secret }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if workflow.variables | length > 0 %}
                            <div>
                                {% for variable in workflow.variables %}
                                <span title="Variable" class="badge text-bg-variable variable-or-secret" data-type="variable" data-value="{{ variable }}">{{ variable }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script type="text/javascript">
    const PageManager = {
        selectVariable: null,
        selectSecret: null,

        init: function() {
            this.selectVariable = new Choices(document.getElementById('variables'), { removeItemButton: true, searchResultLimit: -1, placeholderValue: "{{ results.count('variables') | format_number }} variables" });
            this.selectSecret = new Choices(document.getElementById('secrets'), { removeItemButton: true, searchResultLimit: -1, placeholderValue: "{{ results.count('secrets') | format_number }} secrets" });

            this.selectVariable.passedElement.element.addEventListener('change', function (event) { PageManager.filter() });
            this.selectSecret.passedElement.element.addEventListener('change', function (event) { PageManager.filter() });

            $('.search').keyup(function () {
                PageManager.filter();
            });

            $('.search').each(function() {
                $(this).val('');
            });
        },

        filter: function() {
            let variableFilter = this.selectVariable.getValue(true);
            let secretFilter = this.selectSecret.getValue(true);

            $('#workflows .workflow').removeClass('d-none');
            if (variableFilter.length === 0 && secretFilter.length === 0) {
                $('#workflows .workflow .variable-or-secret').removeClass('d-none');
            } else {
                // Easier to do this from a hidden state.
                $('#workflows .workflow .variable-or-secret').addClass('d-none');

                $('#workflows .workflow').each(function () {
                    let visible = 0;
                    $(this).find('.variable-or-secret').each(function () {
                        let type = $(this).data('type');
                        let value = $(this).data('value');

                        if (type === 'variable' && variableFilter.includes(value)) {
                            visible++;
                            $(this).removeClass('d-none');
                        } else if (type === 'secret' && secretFilter.includes(value)) {
                            visible++;
                            $(this).removeClass('d-none');
                        }
                    });

                    if (visible === 0) {
                        $(this).addClass('d-none');
                    }
                });
            }

            let searchFor = $('#filters .search').val().toLowerCase();
            if (searchFor.length > 0) {
                $('#workflows .workflow').each(function () {
                    if (!$(this).data('name').toLowerCase().includes(searchFor) && !$(this).hasClass('d-none')) {
                        $(this).addClass('d-none');
                    }
                });
            }

            $('#filters .visible-results').text($('#workflows .workflow:visible').length.toLocaleString());
        }
    };

    $(document).ready(function () {
        PageManager.init();
    });
</script>
