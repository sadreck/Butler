<div class="container mt-2 mb-5">
    <div class="row">
        <div class="col text-center">
            <h1 class="org display-2 fw-bold p-3">{{ org }}</h1>
        </div>
     </div>

    <div class="row mt-2">
        <div class="col-4" id="container-runners">
            <h3><span class="visible-results">{{ results.count('runners') | format_number }}</span> Runners</h3>
            <div class="input-group mb-1">
                <input type="text" class="form-control search" placeholder="search">
            </div>
            <div class="row filters">
                <div class="col">
                    <!-- Self-Hosted -->
                    {{ badge_filter(
                        'filter-self-hosted',
                        'text-bg-primary',
                        'self-hosted (' ~ (results.count('self-hosted') | format_number) ~ ')',
                        '<i class="fa-solid fa-computer"></i>',
                        True)
                    }}
                    <!-- GitHub Hosted -->
                    {{ badge_filter(
                        'filter-github-hosted',
                        'text-bg-primary',
                        'github (' ~ (results.count('github') | format_number) ~ ')',
                        '<i class="fa-brands fa-github"></i>',
                        True)
                    }}
                    <!-- Unsupported -->
                    {{ badge_filter(
                        'filter-unsupported',
                        'text-bg-warning',
                        'unsupported (' ~ (results.count('unsupported') | format_number) ~ ')',
                        '<i class="fa-brands fa-github"></i>',
                        True)
                    }}
                </div>
            </div>

            <div class="row mt-3">
                <div class="col">
                    <div class="sidebar">
                        <ul class="list-group list-group-flush">
                            {% for runner in results.runners %}
                            <li
                                    class="list-group-item d-flex align-items-center overflow-auto ps-0 runner"
                                    data-filter-github-hosted="{{ 0 if runner.self_hosted else 1 }}"
                                    data-filter-self-hosted="{{ 1 if runner.self_hosted else 0 }}"
                                    data-filter-unsupported="{{ 0 if runner.supported else 1 }}"
                            >
                                <div class="ms-2 me-auto">
                                    {% if runner.self_hosted %}
                                    <span title="Self Hosted"><i class="fa-solid fa-computer"></i></span>
                                    {% else %}
                                    {% set background = '' if runner.supported else 'text-warning' %}
                                    {% set title = '' if runner.supported else '(Not Supported)' %}
                                    <span title="GitHub Hosted {{ title }}"><i class="fa-brands fa-github {{ background }}"></i></span>
                                    {% endif %}
                                    <a href="#" class="name">{{ runner.name }}</a>
                                </div>
                                <span class="badge text-bg-secondary">{{ runner.count }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col" id="container-workflows">
            <h3><span class="visible-results">{{ results.count('workflows') | format_number }}</span> Workflows</h3>
            <div class="input-group mb-1">
                <input type="text" class="form-control search" placeholder="search">
            </div>
            <div class="row">
                <div class="col text-end">
                    <a href="#" class="badge text-bg-info selected-filter d-none text-decoration-none"><span class="filter-value"></span> <i class="fa-solid fa-xmark"></i></a>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col">
                    <ul class="list-group list-group-flush">
                        {% for result in results.workflows %}
                        <li class="list-group-item ps-0 workflow">
                            <div class="row">
                                <div class="col">
                                    <a href="{{ result.workflow.url(True) }}" class="name">{{ result.workflow }}</a>
                                </div>
                            </div>
                            <div class="row mt-1">
                                <div class="col runners">
                                    {% for runner in result.runners.values()|list %}
                                    {% set background = 'text-bg-primary' if runner.supported else 'text-bg-warning' %}

                                    <span class="badge {{ background }} runner">
                                        {% if runner.self_hosted %}
                                        <span title="Self Hosted"><i class="fa-solid fa-computer"></i></span>
                                        {% else %}
                                        <span title="GitHub Hosted"><i class="fa-brands fa-github"></i></span>
                                        {% endif %}
                                        {{ runner.name }}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const RunnerManager = {
        init: function() {
            $('.filter').click(function() {
                RunnerManager.filter($(this));
            });

            $('.search').keyup(function() {
                RunnerManager.filter($(this));
            });

            $('#container-runners .runner .name').click(function() {
                RunnerManager.filter_by_runner($(this));
                return false;
            });

            $('#container-workflows .selected-filter').click(function() {
                $(this).addClass('d-none').find('.filter-value').text('');
                RunnerManager.filter(null);
                return false;
            });
        },

        filter: function(element) {
            this.__runner_filters();
            this.__workflow_filters();
            this.__update_result_counts();
        },

        filter_by_runner: function(element) {
            $('#container-workflows .workflow').addClass('d-none');

            let runner_name = $(element).text().trim().toLowerCase();

            $('#container-workflows .selected-filter').removeClass('d-none').find('.filter-value').text(runner_name);

            $('#container-workflows .workflow .runners .runner').each(function() {
                let name = $(this).text().trim().toLowerCase();
                if (name === runner_name) {
                    $(this).closest('.workflow').removeClass('d-none');
                }
            });

            this.__update_result_counts();
        },

        __runner_filters: function() {
            // Get state of current filters.
            let filters = {};
            $('#container-runners .filter').each(function() {
                filters[$(this).data('filter')] = $(this).is(':checked');
            });

            let only_unsupported_checked = !filters['filter-github-hosted'] && !filters['filter-self-hosted'] && filters['filter-unsupported'];

            $('#container-runners .runner').each(function() {
                // Start from a visible state.
                $(this).removeClass('d-none');

                let is_github_hosted = $(this).data('filter-github-hosted') == 1;
                let is_self_hosted = $(this).data('filter-self-hosted') == 1;
                let is_unsupported = $(this).data('filter-unsupported') == 1;

                if (is_github_hosted && !filters['filter-github-hosted']) {
                    $(this).addClass('d-none');
                } else if (is_self_hosted && !filters['filter-self-hosted']) {
                    $(this).addClass('d-none');
                } else if (is_unsupported && !filters['filter-unsupported']) {
                    $(this).addClass('d-none');
                }

                if (is_unsupported && only_unsupported_checked) {
                    $(this).removeClass('d-none');
                }
            });

            let searchFor = $('#container-runners .search').val().toLowerCase();
            if (searchFor.length > 0) {
                $('#container-runners .runner').each(function() {
                    let name = $(this).find('.name').text().trim().toLowerCase();
                    if (!name.includes(searchFor)) {
                        $(this).addClass('d-none');
                    }
                });
            }
        },

        __workflow_filters: function() {
            $('#container-workflows .workflow').removeClass('d-none');

            let searchFor = $('#container-workflows .search').val().toLowerCase();
            if (searchFor.length > 0) {
                $('#container-workflows .workflow').each(function() {
                    let name = $(this).find('.name').text().trim().toLowerCase();
                    if (!name.includes(searchFor)) {
                        $(this).addClass('d-none');
                    }
                });
            }
        },

        __update_result_counts: function() {
            $('#container-runners .visible-results').text($('#container-runners .runner:visible').length.toLocaleString());
            $('#container-workflows .visible-results').text($('#container-workflows .workflow:visible').length.toLocaleString());
        }
    }

    $(document).ready(function() {
        RunnerManager.init();
    });
</script>
