<div class="container mt-2 mb-5">
    <div class="row">
        <div class="col text-center">
            <h1 class="org display-2 fw-bold p-3">{{ org }}</h1>
        </div>
     </div>

    <div class="row mt-2">
        <div class="col" id="filters">
            <h3><span class="visible-results">{{ results.count('workflows') | format_number }}</span> Runner Usages</h3>
            <div class="input-group mb-1">
                <input type="text" class="form-control search" placeholder="search">
            </div>
            <div class="row">
                <div class="col-4">
                    <select class="form-control" id="self-hosted" multiple>
                        {% for runner in results.runners('self-hosted', True) %}
                        <option value="{{ runner.name }}" data-count="{{ runner.count }}">{{ runner.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-4">
                    <select class="form-control" id="github-hosted" multiple>
                        {% for runner in results.runners('github-hosted', True) %}
                        <option value="{{ runner.name }}" data-count="{{ runner.count }}">{{ runner.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-4">
                    <select class="form-control" id="state">
                        <option value="supported">supported</option>
                        <option value="unsupported">unsupported</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3 mb-5" id="workflows">
        <div class="col striped-rows">
            {% for workflow in results.workflows %}
            <div class="row pb-1 pt-1 strip workflow" data-name="{{ workflow.workflow }}">
                <div class="col">
                    <div class="row">
                        <div class="col">
                            {% if workflow.workflow.repo.archive %}
                            <span class="badge text-bg-warning archived p-1"><i class="fa-solid fa-box-archive"></i></span>
                            {% endif %}

                            {% if workflow.workflow.repo.fork %}
                            <span class="badge text-bg-secondary forked p-1"><i class="fa-solid fa-code-fork"></i></span>
                            {% endif %}

                            <a href="{{ workflow.workflow.url(True) }}">{{ workflow.workflow }}</a>
                        </div>
                    </div>
                    <div class="row pb-1">
                        <div class="col ms-4">
                            {% for runner in workflow.runners.values()|list %}
                            {% set type = 'self-hosted' if runner.self_hosted else 'github-hosted' %}
                            {% set deprecated = 'text-bg-deprecated' if not runner.supported else '' %}
                            <span
                                    title="{{ type }}" class="badge text-bg-{{ type }} {{ deprecated }} runner"
                                    data-type="{{ type }}"
                                    data-name="{{ runner.name }}"
                                    data-supported="{{ 1 if runner.supported else 0 }}"
                            >{{ runner.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script type="text/javascript">
    const PageManager = {
        selectSelfHosted: null,
        selectGitHubHosted: null,
        selectState: null,

        init: function() {
            this.selectSelfHosted = ChoicesTemplateManager.init_with_count(document.getElementById('self-hosted'), "{{ results.count('self-hosted') | format_number }} self-hosted");
            this.selectGitHubHosted = ChoicesTemplateManager.init_with_count(document.getElementById('github-hosted'), "{{ results.count('github-hosted') | format_number }} github-hosted");
            this.selectState = new Choices(document.getElementById('state'), { removeItemButton: true, searchResultLimit: -1, placeholderValue: "state" });

            this.selectSelfHosted.passedElement.element.addEventListener('change', function (event) { PageManager.filter(); });
            this.selectGitHubHosted.passedElement.element.addEventListener('change', function (event) { PageManager.filter(); });
            this.selectState.passedElement.element.addEventListener('change', function (event) { PageManager.filter() });

            $('.search').keyup(function () {
                PageManager.filter();
            });

            $('.search').each(function() {
                $(this).val('');
            });
        },

        filter: function() {
            let selfHostedFilter = this.selectSelfHosted.getValue(true);
            let githubHostedFilter = this.selectGitHubHosted.getValue(true);
            let stateFilter = this.selectState.getValue(true) ?? '';

            $('#workflows .workflow').removeClass('d-none');
            if (selfHostedFilter.length === 0 && githubHostedFilter.length === 0 && stateFilter.length === 0) {
                $('#workflows .workflow .runner').removeClass('d-none');
            } else {
                // Easier to do this from a hidden state.
                $('#workflows .workflow .runner').addClass('d-none');

                $('#workflows .workflow').each(function () {
                    let visible = 0;
                    $(this).find('.runner').each(function () {
                        let type = $(this).data('type');
                        let name = $(this).data('name');
                        let supported = $(this).data('supported') == '1';

                        if (selfHostedFilter.length === 0 && githubHostedFilter.length === 0 && stateFilter.length > 0) {
                            // Only supported/unsupported.
                            if (stateFilter === 'supported' && supported) {
                                visible++;
                                $(this).removeClass('d-none');
                            } else if (stateFilter === 'unsupported' && !supported) {
                                visible++;
                                $(this).removeClass('d-none');
                            }
                        } else {
                            let is_supported = (stateFilter === 'supported' && supported);
                            let not_supported = (stateFilter === 'unsupported' && !supported);
                            let show = is_supported || not_supported || stateFilter.length === 0;

                            if (type === 'self-hosted' && selfHostedFilter.includes(name) && show) {
                                visible++;
                                $(this).removeClass('d-none');
                            } else if (type === 'github-hosted' && githubHostedFilter.includes(name) && show) {
                                visible++;
                                $(this).removeClass('d-none');
                            }
                        }
                    });

                    if (visible === 0) {
                        $(this).addClass('d-none');
                    }
                });
            }

            let searchFor = $('#filters .search').val().toLowerCase();
            if (searchFor.length > 0) {
                $('#workflows .workflow').each(function () {
                    if (!$(this).data('name').toLowerCase().includes(searchFor) && !$(this).hasClass('d-none')) {
                        $(this).addClass('d-none');
                    }
                });
            }

            $('#filters .visible-results').text($('#workflows .workflow:visible').length.toLocaleString());
        }
    };

    $(document).ready(function () {
        PageManager.init();
    });
</script>
