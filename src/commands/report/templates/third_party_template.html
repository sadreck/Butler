<div class="container mt-2 mb-5">
    <div class="row">
        <div class="col text-center">
            <h1 class="org display-2 fw-bold p-3">{{ org }}</h1>
        </div>
     </div>

    <div class="row mt-2">
        <div class="col" id="filters">
            <h3><span class="visible-results">{{ results.count('all') | format_number }}</span> Third Party Actions</h3>
            <div class="input-group mb-1">
                <input type="text" class="form-control search" placeholder="search">
            </div>
            <div class="row choices-max-height">
                <div class="col-3">
                    <select class="form-control" id="org" multiple>
                        <option value="trusted">trusted</option>
                        <option value="untrusted">untrusted</option>
                    </select>
                </div>
                <div class="col-3">
                    <select class="form-control" id="type" multiple>
                        <option value="source">source</option>
                        <option value="archived">archived</option>
                        <option value="fork">fork</option>
                    </select>
                </div>
                <div class="col-3">
                    <select class="form-control" id="ref" multiple>
                        <option value="tag">tag</option>
                        <option value="branch">branch</option>
                        <option value="commit">commit</option>
                    </select>
                </div>
                <div class="col-3">
                    <select class="form-control" id="state" multiple>
                        <option value="supported">supported</option>
                        <option value="deprecated">deprecated</option>
                    </select>
                </div>
            </div>
            <div class="row mt-1">
                <div class="col text-end">
                    <span class="badge text-bg-tag">tag</span>
                    <span class="badge text-bg-branch">branch</span>
                    <span class="badge text-bg-commit">commit</span>
                    <span class="badge text-bg-deprecated">deprecated</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3 mb-5" id="actions">
        <div class="col">
            {% for action in results.actions %}
            <div
                    class="row action striped-rows"
                    data-org="{{ 'trusted' if action.trusted else 'untrusted' }}"
                    data-type="{{ action.action.repo.source_type }}"
                    data-name="{{ action.name }}"
            >
                <div class="col">
                    <div class="row pb-1 pt-1 strip">
                        <div class="col">
                            {% if action.trusted %}
                            <i class="fa-solid fa-building-shield trusted-org" title="Trusted Organisation"></i>
                            {% else %}
                            <i class="fa-solid fa-building-circle-exclamation untrusted-org" title="Untrusted Organisation"></i>
                            {% endif %}

                            <span id="expand-collapse-{{ loop.index }}">
                                <i class="fa-solid fa-circle-chevron-right fa-xs expand-icon"></i>
                                <i class="fa-solid fa-circle-chevron-down fa-xs collapse-icon d-none"></i>
                            </span>
                            <a
                                    href="{{ action.action.url() }}"
                                    class="name me-1"
                                    target="_blank"
                                    data-details="action-details-{{ loop.index }}"
                                    data-refs="action-refs-{{ loop.index }}"
                                    data-expand-collapse="expand-collapse-{{ loop.index }}"
                            >{{ action.name }}</a>

                            {% if action.action.repo.archive %}
                            <span class="badge text-bg-warning archived p-1"><i class="fa-solid fa-box-archive"></i></span>
                            {% endif %}

                            {% if action.action.repo.fork %}
                            <span class="badge text-bg-secondary forked p-1"><i class="fa-solid fa-code-fork"></i></span>
                            {% endif %}
                        </div>
                        <div class="col-1 text-end">
                            <span class="badge stars">{{ action.stars_formatted }}<i class="fa-solid fa-star ms-1"></i></span>
                        </div>
                    </div>

                    <div class="row pb-1 pt-1 strip" id="action-refs-{{ loop.index }}">
                        <div class="col ms-4">
                            {% if action.tags | length > 0 %}
                            <div>
                                {% for tag, info in action.tags.items() %}
                                {% if info.deprecated %}
                                <span class="badge ref tag text-bg-deprecated" data-type="tag" data-state="deprecated" title="tag">{{ tag }}</span>
                                {% else %}
                                <span class="badge ref tag text-bg-tag" data-type="tag" data-state="supported" title="tag">{{ tag }}</span>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if action.branches | length > 0 %}
                            <div>
                                {% for branch, info in action.branches.items() %}
                                {% if info.deprecated %}
                                <span class="badge ref branch text-bg-deprecated" data-type="branch" data-state="deprecated" title="branch">{{ branch }}</span>
                                {% else %}
                                <span class="badge ref branch text-bg-branch" data-type="branch" data-state="supported" title="branch">{{ branch }}</span>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if action.commits | length > 0 %}
                            <div>
                                {% for commit, info in action.commits.items() %}
                                {% if info.deprecated %}
                                <span class="badge ref commit text-bg-deprecated" data-type="commit" data-state="deprecated" title="commit for {{ info.resolved_type }}">{{ commit[:8] }} ({{ info.resolved_ref }})</span>
                                {% else %}
                                <span class="badge ref commit text-bg-commit" data-type="commit" data-state="supported" title="commit for {{ info.resolved_type }}">{{ commit[:8] }} ({{ info.resolved_ref }})</span>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Action details -->
                    <div class="row mt-2 mb-2 d-none striped-rows2" id="action-details-{{ loop.index }}">
                        <div class="col">
                            {% for ref, info in action.refs().items() %}
                            <div class="row mb-1 strip2">
                                <div class="col-1 ms-4">
                                    {% set deprecated = 'text-bg-deprecated' if info.deprecated else '' %}
                                    {% if info.label|lower == 'tag' %}
                                    <span class="badge text-bg-tag {{ deprecated }} d-block">tag</span>
                                    {% elif info.label|lower == 'branch' %}
                                    <span class="badge text-bg-branch {{ deprecated }} d-block">branch</span>
                                    {% elif info.label|lower == 'commit' %}
                                    <span class="badge text-bg-commit {{ deprecated }} d-block">commit</span>
                                    {% endif %}
                                </div>
                                <div class="col-1">
                                    <span class="badge text-black d-block">{{ info.usage | format_number }}</span>
                                </div>
                                <div class="col">
                                    <div class="row">
                                        <div class="col">
                                            <span id="expand-collapse-{{ info.unique }}">
                                                <i class="fa-solid fa-circle-chevron-right fa-xs expand-icon"></i>
                                                <i class="fa-solid fa-circle-chevron-down fa-xs collapse-icon d-none"></i>
                                            </span>
                                            <a
                                                    href="{{ info.url }}"
                                                    target="_blank"
                                                    class="ref-name font-monospace small"
                                                    data-details="action-usages-{{ info.unique }}"
                                                    data-expand-collapse="expand-collapse-{{ info.unique }}"
                                            >{{ ref }}</a>
                                            {% if info.label|lower == 'commit' %}
                                            <span class="badge text-bg-{{ info.resolved_type }} ms-1">{{ info.resolved_ref }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div id="action-usages-{{ info.unique }}" class="d-none striped-rows3">
                                        {% for workflow_name, workflow in info.workflows.items() %}
                                        <div class="row mb-1 mt-1 strip3">
                                            <div class="col">
                                                <a href="{{ workflow.browser_url() }}" target="_blank">{{ workflow }}</a>
                                            </div>
                                            <div class="col-1 text-end">
                                                {% if workflow.repo.archive %}
                                                <span title="Archived Repository"><i class="fa-solid fa-box-archive text-warning"></i></span>
                                                {% endif %}

                                                {% if workflow.repo.fork %}
                                                <span title="Forked Repository"><i class="fa-solid fa-code-fork"></i></span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script type="text/javascript">
    const PageManager = {
        selectOrg: null,
        selectType: null,
        selectRef: null,
        selectState: null,

        init: function() {
            this.selectOrg = new Choices(document.getElementById('org'), { removeItemButton: true, searchResultLimit: -1, placeholderValue: 'org trust' });
            this.selectType = new Choices(document.getElementById('type'), { removeItemButton: true, searchResultLimit: -1, placeholderValue: 'repo type' });
            this.selectRef = new Choices(document.getElementById('ref'), { removeItemButton: true, searchResultLimit: -1, placeholderValue: 'ref type' });
            this.selectState = new Choices(document.getElementById('state'), { removeItemButton: true, searchResultLimit: -1, placeholderValue: 'state' });

            this.selectOrg.passedElement.element.addEventListener('change', function (event) { PageManager.filter() });
            this.selectType.passedElement.element.addEventListener('change', function (event) { PageManager.filter() });
            this.selectRef.passedElement.element.addEventListener('change', function (event) { PageManager.filter() });
            this.selectState.passedElement.element.addEventListener('change', function (event) { PageManager.filter() });

            $('.action .name').click(function () {
                let box = $('#' + $(this).data('details'));
                let refs = $('#' + $(this).data('refs'));
                let expand_collapse = $('#' + $(this).data('expand-collapse'));
                if ($(box).hasClass('d-none')) {
                    $(expand_collapse).find('.expand-icon').addClass('d-none');
                    $(expand_collapse).find('.collapse-icon').removeClass('d-none');
                    $(refs).addClass('d-none');
                    $(box).removeClass('d-none');
                } else {
                    $(expand_collapse).find('.expand-icon').removeClass('d-none');
                    $(expand_collapse).find('.collapse-icon').addClass('d-none');
                    $(box).addClass('d-none');
                    $(refs).removeClass('d-none');
                }
                return false;
            });

            $('.action .ref-name').click(function () {
                let box = $('#' + $(this).data('details'));
                let expand_collapse = $('#' + $(this).data('expand-collapse'));
                if ($(box).hasClass('d-none')) {
                    $(expand_collapse).find('.expand-icon').addClass('d-none');
                    $(expand_collapse).find('.collapse-icon').removeClass('d-none');
                    $(box).removeClass('d-none');
                } else {
                    $(expand_collapse).find('.expand-icon').removeClass('d-none');
                    $(expand_collapse).find('.collapse-icon').addClass('d-none');
                    $(box).addClass('d-none');
                }
                return false;
            });

            $('.search').keyup(function () {
                PageManager.filter();
            });

            $('.search').each(function() {
                $(this).val('');
            });
        },

        filter: function() {
            // Start from a visible state.
            $('#actions .action').removeClass('d-none');
            $('#actions .action .ref').removeClass('d-none');

            let orgFilter = this.selectOrg.getValue(true);
            let typeFilter = this.selectType.getValue(true);
            let refFilter = this.selectRef.getValue(true);
            let stateFilter = this.selectState.getValue(true);

            // Hide based on trust and repo type.
            $('#actions .action').each(function () {
                let org = $(this).data('org');
                let type = $(this).data('type');

                if (orgFilter.length > 0 && !orgFilter.includes(org)) {
                    $(this).addClass('d-none');
                } else if (typeFilter.length > 0 && !typeFilter.includes(type)) {
                    $(this).addClass('d-none');
                }
            });

            // Refs are part of the action.
            $('#actions .action .ref').each(function () {
                let type = $(this).data('type');
                let state = $(this).data('state');

                if (refFilter.length > 0 && !refFilter.includes(type)) {
                    $(this).addClass('d-none');
                }

                if (stateFilter.length > 0 && !stateFilter.includes(state)) {
                    $(this).addClass('d-none');
                }
            });

            // Hide actions where all refs are hidden.
            $('#actions .action').each(function () {
                if ($(this).find('.ref:visible').length === 0) {
                    $(this).addClass('d-none');
                }
            });

            let searchFor = $('#filters .search').val().toLowerCase();
            if (searchFor.length > 0) {
                $('#actions .action').each(function () {
                    if (!$(this).data('name').toLowerCase().includes(searchFor) && !$(this).hasClass('d-none')) {
                        $(this).addClass('d-none');
                    }
                });
            }

            $('#filters .visible-results').text($('#actions .action:visible').length.toLocaleString());
        }
    };

    $(document).ready(function() {
        PageManager.init();
    });
</script>
