<div class="container mt-2 mb-5">
    <div class="row">
        <div class="col text-center">
            <h1 class="org display-2 fw-bold p-3 glow">{{ org }}</h1>
        </div>
     </div>

    <div class="row mt-2">
        <div class="col-4 repo-box">
            <h3>{{ "{:,}".format(results.count_repos()) }} Repositories</h3>
            <div class="input-group mb-2">
                <input type="text" class="form-control search-repo" placeholder="search">
            </div>
            <div class="row mb-3">
                <div class="col">
                    <span class="badge text-bg-warning"><i class="fa-solid fa-box-archive"></i> {{ "{:,}".format(results.count_archived_repos()) }} archived</span>
                    <span class="badge text-bg-secondary"><i class="fa-solid fa-code-fork"></i> {{ "{:,}".format(results.count_forked_repos()) }} forked</span>
                </div>
                <div class="col-4 text-end">
                    <span class="badge text-bg-secondary results-count"><span class="total">0</span> results</span>
                </div>
            </div>
            <div class="view-height">
                <ul class="list-group list-group-flush repo-list">
                    {% for repo in results.repos %}
                    <li class="list-group-item d-flex align-items-center overflow-auto ps-0 result-item">
                        <div class="ms-2 me-auto">
                            {% if repo.instance.archive %}
                            <i class="fa-solid fa-box-archive text-warning" title="Archived"></i>
                            {% elif repo.instance.fork %}
                            <i class="fa-solid fa-code-fork text-secondary" title="Fork"></i>
                            {% endif %}
                            <a href="#" class="repo-link" data-name="{{ repo.instance.name }}">{{ repo.instance.name }}</a>
                        </div>
                        <span class="badge text-bg-secondary" title="Workflows &amp; Actions">{{ repo.count }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="col workflow-box">
            <h3>{{ "{:,}".format(results.count_workflows_and_actions()) }} Workflows &amp; Actions</h3>
            <div class="input-group mb-2">
                <input type="text" class="form-control search-workflow" placeholder="search">
            </div>
            <div class="row mb-3">
                <div class="col">
                    <a href="#" class="filter">
                        <span class="badge text-bg-info">
                            <span class="filter-value"></span> <i class="fa-solid fa-xmark"></i>
                        </span>
                    </a>

                    <span class="badge text-bg-primary"><i class="fa-brands fa-git-alt"></i> {{ "{:,}".format(results.count_workflows()) }} workflows</span>
                    <span class="badge text-bg-primary"><i class="fa-brands fa-github"></i> {{ "{:,}".format(results.count_actions()) }} actions</span>
                    <span class="badge text-bg-primary"><i class="fa-brands fa-docker"></i> {{ "{:,}".format(results.count_docker()) }} docker</span>
                </div>
                <div class="col-4 text-end">
                    <span class="badge text-bg-secondary results-count"><span class="total">0</span> results</span>
                </div>
            </div>
            <div class="row workflow-list">
                <div class="col">
                    {% for workflow in results.workflows %}
                    <div class="row border-bottom pb-1 result-item">
                        <div class="col">
                            {% if workflow.instance.repo.archive %}
                            <span title="Archived Repository"><i class="fa-solid fa-box-archive text-warning"></i></span>
                            {% endif %}

                            {% if workflow.instance.repo.fork %}
                            <span title="Forked Repository"><i class="fa-solid fa-code-fork"></i></span>
                            {% endif %}

                            <a href="{{ workflow.instance.url(True) }}" target="_blank" class="workflow-link" data-repo="{{ workflow.instance.repo.name }}">{{ workflow.instance }}</a>
                        </div>
                        <div class="col-1 text-end">
                            {% if workflow.instance.type == 1 %}
                            <i class="fa-brands fa-git-alt text-primary" title="GitHub Workflow"></i>
                            {% elif workflow.instance.type == 2 %}
                            <i class="fa-brands fa-github text-primary" title="GitHub Action"></i>
                            {% elif workflow.instance.type == 3 %}
                            <i class="fa-brands fa-docker text-primary" title="Docker"></i>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const WorkflowManager = {
        init: function() {
            $('.filter').hide();
            $('.search-repo').val('');
            $('.search-workflow').val('');
            this.__bind();
            this.__apply_filters();
        },

        __bind: function() {
            $('.search-repo, .search-workflow').keyup(function() {
                WorkflowManager.__apply_filters();
            });

            $('.repo-link').click(function() {
                return WorkflowManager.__filter_workflows($(this));
            });

            $('.filter').click(function() {
                return WorkflowManager.__filter_clear($(this));
            });
        },

        __apply_filters: function() {
            let searchRepo = $('.search-repo').val();
            if (searchRepo.length === 0) {
                $('.repo-list .result-item').removeClass('d-none');
                $('.repo-box .total').text($('.repo-list li:visible').length);
            } else {
                $('.repo-list .result-item').addClass('d-none').each(function() {
                    let name = $(this).find('.repo-link').text().toLowerCase();
                    if (name.includes(searchRepo)) {
                        $(this).removeClass('d-none');
                    }
                });
            }

            let searchWorkflow = $('.search-workflow').val();
            if (searchWorkflow.length === 0) {
                $('.workflow-list .result-item').removeClass('d-none');
                $('.workflow-box .total').text($('.workflow-box .result-item:visible').length);
            } else {
                $('.workflow-list .result-item').addClass('d-none').each(function() {
                    let name = $(this).find('.workflow-link').text().toLowerCase();
                    if (name.includes(searchWorkflow)) {
                        $(this).removeClass('d-none');
                    }
                });
            }

            this.__update_result_counts();
        },

        __filter_clear: function(element) {
            $('.workflow-list .result-item').removeClass('d-none');
            $(element).hide();
            this.__update_result_counts();
            return false;
        },


        __filter_workflows: function(element) {
            let selected_name = element.data('name').toLowerCase();
            $('.filter').show().find('.filter-value').text(selected_name);

            $('.workflow-list .result-item').addClass('d-none').each(function() {
                let name = $(this).find('.workflow-link').data('repo').toLowerCase();
                if (name === selected_name) {
                    $(this).removeClass('d-none');
                }
            });

            this.__update_result_counts();
            return false;
        },

        __update_result_counts: function() {
            $('.repo-box .total').text($('.repo-list li:visible').length);
            $('.workflow-box .total').text($('.workflow-box .result-item:visible').length);
        }
    };

    $(document).ready(function() {
        WorkflowManager.init();
    });
</script>