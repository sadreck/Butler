<div class="container mt-2 mb-5">
    <div class="row">
        <div class="col text-center">
            <h1 class="org display-2 fw-bold p-3">{{ org }}</h1>
        </div>
     </div>

    <div class="row mt-2">
        <div class="col" id="filters">
            <h3><span class="visible-results">{{ results.count('workflows_and_actions') | format_number }}</span> Workflows &amp; Actions</h3>
            <div class="input-group mb-1">
                <input type="text" class="form-control search" placeholder="search">
            </div>
            <div class="row">
                <div class="col-2">
                    <select class="form-control" id="visibility" multiple>
                        <option value="public" data-icon="fa-solid fa-lock-open">public</option>
                        <option value="private" data-icon="fa-solid fa-lock">private</option>
                    </select>
                </div>
                <div class="col-3">
                    <select class="form-control" id="type" multiple>
                        <option value="source">source</option>
                        <option value="archived">archived</option>
                        <option value="fork">fork</option>
                    </select>
                </div>
                <div class="col-3">
                    <select class="form-control" id="component" multiple>
                        <option value="workflow">workflow</option>
                        <option value="action">action</option>
                        <option value="docker">docker</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3" id="components">
        <div class="col striped-rows">
            {% for workflow in results.workflows %}
            <div
                    class="row pb-1 pt-1 workflow"
                    data-name="{{ workflow.instance }}"
                    data-visibility="{{ workflow.instance.repo.visibility_name }}"
                    data-component="{{ workflow.instance.type_name }}"
                    data-type="{{ workflow.instance.repo.source_type }}"
            >
                <div class="col">
                    {% if workflow.instance.repo.visibility == 1 %}
                    <i class="fa-solid fa-lock-open text-secondary" title="Public"></i>
                    {% elif  workflow.instance.repo.visibility == 2 %}
                    <i class="fa-solid fa-lock" title="Private"></i>
                    {% endif %}

                    {% if  workflow.instance.repo.archive %}
                    <i class="fa-solid fa-box-archive text-warning" title="Archived"></i>
                    {% elif  workflow.instance.repo.fork %}
                    <i class="fa-solid fa-code-fork text-secondary" title="Fork"></i>
                    {% endif %}

                    {% if workflow.instance.type_name == 'workflow' %}
                    <!-- Workflow -->
                    {% elif workflow.instance.type_name == 'action' %}
                    <i class="fa-brands fa-github" title="GitHub Action"></i>
                    {% elif workflow.instance.type_name == 'docker' %}
                    <i class="fa-brands fa-docker text-primary" title="Docker"></i>
                    {% endif %}

                    <a href="{{ workflow.instance.url(True) }}" class="name">{{ workflow.instance }}</a>
                </div>
                <div class="col-2 text-end">
                    <span class="badge bg-secondary">jobs ({{ workflow.job_count }})</span>
                    <span class="badge bg-secondary">triggers ({{ workflow.triggers | length }})</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script type="text/javascript">
    const PageManager = {
        selectVisibility: null,
        selectType: null,
        selectComponent: null,

        init: function() {
            this.selectVisibility = new Choices(document.getElementById('visibility'), { removeItemButton: true, placeholderValue: 'visibility' });
            this.selectType = new Choices(document.getElementById('type'), { removeItemButton: true, placeholderValue: 'type' });
            this.selectComponent = new Choices(document.getElementById('component'), { removeItemButton: true, placeholderValue: 'component' });

            this.selectVisibility.passedElement.element.addEventListener('change', function (event) { PageManager.filter() });
            this.selectType.passedElement.element.addEventListener('change', function (event) { PageManager.filter() });
            this.selectComponent.passedElement.element.addEventListener('change', function (event) { PageManager.filter() });

            $('.search').keyup(function () {
                PageManager.filter();
            });

            $('.search').each(function() {
                $(this).val('');
            });
        },

        filter: function() {
            // Start from a visible state.
            $('#components .workflow').removeClass('d-none');

            let visibilityFilter = this.selectVisibility.getValue(true);
            let typeFilter = this.selectType.getValue(true);
            let componentFilter = this.selectComponent.getValue(true);

            $('#components .workflow').each(function () {
                let visibility = $(this).data('visibility');
                let type = $(this).data('type');
                let component = $(this).data('component');

                if (visibilityFilter.length > 0 && !visibilityFilter.includes(visibility)) {
                    $(this).addClass('d-none');
                } else if (typeFilter.length > 0 && !typeFilter.includes(type)) {
                    $(this).addClass('d-none');
                } else if (componentFilter.length > 0 && !componentFilter.includes(component)) {
                    $(this).addClass('d-none');
                }
            });

            let searchFor = $('#filters .search').val().toLowerCase();
            if (searchFor.length > 0) {
                $('#components .workflow').each(function () {
                    if (!$(this).data('name').toLowerCase().includes(searchFor) && !$(this).hasClass('d-none')) {
                        $(this).addClass('d-none');
                    }
                });
            }

            $('#filters .visible-results').text($('#components .workflow:visible').length.toLocaleString());
        }
    };

    $(document).ready(function() {
        PageManager.init();
    });
</script>
