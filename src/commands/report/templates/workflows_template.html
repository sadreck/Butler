<div class="container mt-2 mb-5">
    <div class="row">
        <div class="col text-center">
            <h1 class="org display-2 fw-bold p-3 glow">{{ org }}</h1>
        </div>
     </div>

    <div class="row mt-2">
        <div class="col-4 repo-box">
            <h3><span class="total">{{ "{:,}".format(results.count_repos()) }}</span> Repositories</h3>
            <div class="input-group mb-2">
                <input type="text" class="form-control search-repo" placeholder="search">
            </div>
            <div class="row mb-3">
                <div class="col">
                    <span class="badge text-bg-primary d-inline-flex align-items-center gap-1 p-2">
                        <input class="form-check-input m-0 align-middle filter filter-source-repos" data-filter="source" type="checkbox" role="switch" id="show-source-repos" checked>
                        <label class="form-check-label m-0" for="show-source-repos"><i class="fa-solid fa-code"></i> {{ "{:,}".format(results.count_source_repos()) }} sources</label>
                    </span>
                    <span class="badge text-bg-warning d-inline-flex align-items-center gap-1 p-2">
                        <input class="form-check-input m-0 align-middle filter filter-archived-repos" data-filter="archived" type="checkbox" role="switch" id="show-archived-repos" checked>
                        <label class="form-check-label m-0" for="show-archived-repos"><i class="fa-solid fa-box-archive"></i> {{ "{:,}".format(results.count_archived_repos()) }} archived</label>
                    </span>
                    <span class="badge text-bg-secondary d-inline-flex align-items-center gap-1 p-2">
                        <input class="form-check-input m-0 align-middle filter filter-forked-repos" data-filter="forked" type="checkbox" role="switch" id="show-forked-repos" checked>
                        <label class="form-check-label m-0" for="show-forked-repos"><i class="fa-solid fa-code-fork"></i> {{ "{:,}".format(results.count_forked_repos()) }} forked</label>
                    </span>
                </div>
            </div>
            <div class="view-height">
                <ul class="list-group list-group-flush repo-list">
                    {% for repo in results.repos %}
                    <li
                            class="list-group-item d-flex align-items-center overflow-auto ps-0 repo-item"
                            data-archived="{{ 1 if repo.instance.archive else 0 }}"
                            data-forked="{{ 1 if repo.instance.fork else 0 }}"
                            data-source="{{ 1 if repo.instance.source else 0 }}"
                    >
                        <div class="ms-2 me-auto">
                            {% if repo.instance.archive %}
                            <i class="fa-solid fa-box-archive text-warning" title="Archived"></i>
                            {% elif repo.instance.fork %}
                            <i class="fa-solid fa-code-fork text-secondary" title="Fork"></i>
                            {% endif %}
                            <a
                                    href="#"
                                    class="repo-link"
                                    data-name="{{ repo.instance.name }}"
                            >{{ repo.instance.name }}</a>
                        </div>
                        <span class="badge text-bg-secondary" title="Workflows &amp; Actions">{{ repo.count }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="col workflow-box">
            <h3><span class="total">{{ "{:,}".format(results.count_workflows_and_actions()) }}</span> Workflows &amp; Actions</h3>
            <div class="input-group mb-2">
                <input type="text" class="form-control search-workflow" placeholder="search">
            </div>
            <div class="row mb-3">
                <div class="col">
                    <span class="badge text-bg-primary d-inline-flex align-items-center gap-1 p-2">
                        <input class="form-check-input m-0 align-middle filter filter-workflow" data-filter="workflow" type="checkbox" role="switch" id="show-workflow" checked>
                        <label class="form-check-label m-0" for="show-workflow"><i class="fa-brands fa-git-alt"></i> {{ "{:,}".format(results.count_workflows()) }} workflows</label>
                    </span>
                    <span class="badge text-bg-primary d-inline-flex align-items-center gap-1 p-2">
                        <input class="form-check-input m-0 align-middle filter filter-action" data-filter="action" type="checkbox" role="switch" id="show-action" checked>
                        <label class="form-check-label m-0" for="show-action"><i class="fa-brands fa-github"></i> {{ "{:,}".format(results.count_actions()) }} actions</label>
                    </span>
                    <span class="badge text-bg-primary d-inline-flex align-items-center gap-1 p-2">
                        <input class="form-check-input m-0 align-middle filter filter-docker" data-filter="docker" type="checkbox" role="switch" id="show-docker" checked>
                        <label class="form-check-label m-0" for="show-docker"><i class="fa-brands fa-docker"></i> {{ "{:,}".format(results.count_docker()) }} docker</label>
                    </span>
                </div>
                <div class="col-6 text-end">
                    <a href="#" class="repo-filter d-none">
                        <span class="badge text-bg-info d-inline-flex align-items-center gap-1 p-2">
                            <span class="filter-value"></span> <i class="fa-solid fa-xmark"></i>
                        </span>
                    </a>
                </div>
            </div>
            <div class="row workflow-list">
                <div class="col">
                    {% for workflow in results.workflows %}
                    <div
                            class="row border-bottom pb-1 workflow-item"
                            data-workflow="{{ 1 if workflow.instance.type == 1 else 0 }}"
                            data-action="{{ 1 if workflow.instance.type == 2 else 0 }}"
                            data-docker="{{ 1 if workflow.instance.type == 3 else 0 }}"
                    >
                        <div class="col">
                            {% if workflow.instance.repo.archive %}
                            <span title="Archived Repository"><i class="fa-solid fa-box-archive text-warning"></i></span>
                            {% endif %}

                            {% if workflow.instance.repo.fork %}
                            <span title="Forked Repository"><i class="fa-solid fa-code-fork"></i></span>
                            {% endif %}

                            <a href="{{ workflow.instance.url(True) }}" target="_blank" class="workflow-link" data-repo="{{ workflow.instance.repo.name }}">{{ workflow.instance }}</a>
                        </div>
                        <div class="col-1 text-end">
                            {% if workflow.instance.type == 1 %}
                            <i class="fa-brands fa-git-alt text-primary" title="GitHub Workflow"></i>
                            {% elif workflow.instance.type == 2 %}
                            <i class="fa-brands fa-github text-primary" title="GitHub Action"></i>
                            {% elif workflow.instance.type == 3 %}
                            <i class="fa-brands fa-docker text-primary" title="Docker"></i>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const WorkflowManager = {
        init: function() {
            $('.search-repo').val('');
            $('.search-workflow').val('');
            this.__bind();
            this.__apply_filters();
        },

        __bind: function() {
            $('.search-repo, .search-workflow').keyup(function() {
                WorkflowManager.__apply_filters();
            });

            $('.repo-link').click(function() {
                return WorkflowManager.__filter_repo_workflows($(this));
            });

            $('.filter').click(function() {
                return WorkflowManager.__apply_filters($(this));
            });

            $('.repo-filter').click(function() {
                WorkflowManager.__filter_clear($(this));
                return false;
            });
        },

        __apply_filters: function() {
            /*
                Filter repos.
             */
            $('.repo-item').removeClass('d-none');

            let show_archived_repos = $('.filter-archived-repos').is(':checked');
            let show_forked_repos = $('.filter-forked-repos').is(':checked');
            let show_source_repos = $('.filter-source-repos').is(':checked');

            let searchRepo = $('.search-repo').val().toLowerCase();
            if (searchRepo.length > 0) {
                $('.repo-link').each(function() {
                    let name = $(this).text().toLowerCase().trim();
                    if (!name.includes(searchRepo)) {
                        $(this).closest('.repo-item').addClass('d-none');
                    }
                });
            }

            $('.repo-list .repo-item').each(function() {
                if (!show_archived_repos && $(this).data('archived') == 1) {
                    $(this).addClass('d-none');
                }

                if (!show_forked_repos && $(this).data('forked') == 1) {
                    $(this).addClass('d-none');
                }

                if (!show_source_repos && $(this).data('source') == 1) {
                    $(this).addClass('d-none');
                }
            });

            /*
                Filter workflows.
             */
            $('.workflow-item').removeClass('d-none');

            let show_workflows = $('.filter-workflow').is(':checked');
            let show_actions = $('.filter-action').is(':checked');
            let show_docker = $('.filter-docker').is(':checked');

            let searchWorkflow = $('.search-workflow').val().toLowerCase();
            if (searchWorkflow.length > 0) {
                $('.workflow-link').each(function() {
                    let name = $(this).text().toLowerCase().trim();
                    if (!name.includes(searchWorkflow)) {
                        $(this).closest('.workflow-item').addClass('d-none');
                    }
                });
            }

            $('.workflow-list .workflow-item').each(function() {
                if (!show_workflows && $(this).data('workflow') == 1) {
                    $(this).addClass('d-none');
                }

                if (!show_actions && $(this).data('action') == 1) {
                    $(this).addClass('d-none');
                }

                if (!show_docker && $(this).data('docker') == 1) {
                    $(this).addClass('d-none');
                }
            });

            this.__update_result_counts();
        },

        __filter_clear: function(element) {
            $('.workflow-list .workflow-item').removeClass('d-none');
            $(element).addClass('d-none');
            this.__update_result_counts();
            return false;
        },

        __filter_repo_workflows: function(element) {
            let selected_name = element.data('name').toLowerCase();
            $('.repo-filter').removeClass('d-none').find('.filter-value').text(selected_name);

            $('.workflow-list .workflow-item').addClass('d-none').each(function() {
                let name = $(this).find('.workflow-link').data('repo').toLowerCase();
                if (name === selected_name) {
                    $(this).removeClass('d-none');
                }
            });

            this.__update_result_counts();
            return false;
        },

        __update_result_counts: function() {
            $('.repo-box .total').text($('.repo-list li:visible').length.toLocaleString());
            $('.workflow-box .total').text($('.workflow-box .workflow-item:visible').length.toLocaleString());
        }
    };

    $(document).ready(function() {
        WorkflowManager.init();
    });
</script>